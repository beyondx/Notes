Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2011-07-04T20:13:15+08:00

====== 发生TCP RET的原因 ======
Created 星期一 04 七月 2011
发生TCP RET的原因是很多的，如：
1.客户端访问对方没有进程监听的端口：TCP连接建立就会失败，对方TCP协议栈就会发给客户端一RET且Seq不确定(取决于服务器的TCP的初始值)。
2.客服端访问的端口服务器有进程监听：TCP连接可以成功建立，但服务器进程对客服端进程认证失败时也可能会发RET异常中断连接(如ssh, rlogin, ftp)。
注意：情况1的RET是由TCP协议栈发送的，情况2是TCP协议栈已经和客服端进程的TCP协议栈成功建立连接，但服务进程对客服端认证失败时由其发送的。
3.连接、认证均正常，双方可以正常通信，但服务器端设置了TCP socket选项SO_LINGER，这时数据传输结束后正常的终止流程  (FIN/ACK/FIN/ACK)就被一个RET代替。
4. 连接、认证、TCP socket选项均正常，通信结束后主动断开TCP连接的一方会处于TIME_WAIT状态，这个状态会持续2MSL（maxmum segmet lifetime）约120秒(BSD为30秒)，在此期间已经使用的 4 tuple（源IP、源端口、目标IP、目标端口） 就不能再使用了。否则TCP协议栈就会向再次使用该tuple的进程发送RET。
4.与客服端\服务器端无关，网络中间节点设备如路由器、防火墙、包过滤设备等由于执行了一些安全策略如流量(带宽)管理、访问限制、透明代理等当其接收到不符合安全策略的包时也会向源端发RET。


现在来分析一下上图的结果：
正常情况下，浏览网页时情况1、2、3是不会发生的，因为客户端浏览器进程一般用的临时端口，服务器端进程和端口一般也是开放的且不需要认证。
所以我觉得最有可能还是情况4造成了这么多RET。

情况4 如何发生呢，下面是我的猜想：
1.电信和教育网分配给学校的公网IP有限，因此大量的校内用户访问外网时用的是NAT后的地址，这样对校外的各种服务器而言他们看到的源IP地址很多都是
一样的只是源端口不同。这样一个配置不当的网络服务器当其负载较重时就会RET来自同一IP的大量并发连接。
2.由于出口带宽总有限，电信或学校的网络管理部门肯定会对网络的个地方的网络带宽做限制，当流量超负时网络设备就会向源端发RET。
3.对于一些含有敏感内容的网站，管理部门会对DNS解析请求，目标IP访问设置障碍，通过类似GFW等设备向源端发RET，阻止建立连接。

