Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2011-11-21T20:40:58+08:00

====== Linux 内核模式设置(Kernel Mode Setting)的进展 ======
Created Monday 21 November 2011

http://hi.baidu.com/techofchaos/blog/item/cd6ab454455b76cfb745aec8.html

2010-02-05 13:57

目前 X86 的CPU都提供四种不同的权限模式：Ring0 ~ Ring3。而实际的操作系统一般只使用两个：用户模式（Ring3）和内核模式(Ring0)。用户模式是非特权模式，无法直接操作内存和硬件。应用程序要使用硬件，需要通过系统调用使用内核提供的接口。

Linux 中，大部分的驱动都是直接放到内核中，使用内核模式(Kernel Mode)。__显示驱动是一个例外__，运行在用户模式(User Mode)。用户模式的好处是驱动开发可以和内核解耦。在过去大部分显卡厂商独立开发自己的驱动的时候，也是不得已的一个选择。而缺点就是和内核的交互接口比较复杂，大量数据在内核和用户间传递，X 必须有 Root 权限、内核无法完全管控设备，无法进行电源管理等等。

渐渐的，硬件厂商发现开放源代码有很多好处， Intel 开放了其显示驱动、ATI 被 AMD 收购后也逐步开放了硬件文档和代码。于是将显示驱动由用户模式转到内核模式的工作就逐步展开。统称为__ kernel mode setting (KMS)__。

内核模式设置不是简单的代码搬移。除了清理各个调用接口之外，内存管理也是一大块。TTM 致力于这方面的工作，但是其 API 遇到了一点问题。所以后来 Intel 放弃了使用统一的内存管理系统，转而开发 GEM。GEM 针对 Intel 自己的硬件设计，开发相对容易。所以 Intel 的内核模式设置进展最快，目前功能已经基本开发完成，包括电源管理方面。所以最新的 XServer 开发树中已经删除了原来的用户模式设置的代码。

AMD/ATI 的进展稍微有点慢，因为相比 Intel 的集成显卡，ATI 需要支持的芯片要多很多，功能也复杂一些。而且 GEM 无法满足 ATI 显卡的内存管理要求，所以 ATI 选择继续改进 TTM。最近， TTM 也已经融入了内核，所以已经没有了前进大障碍。目前内核模式设置已经支持 R100~R700，R800 的支持很快也会加入。目前 KMS 还位于 Staging 树中，预计很快就会从 Staging 中毕业。电源管理的支持还没有加入，所以我的本本在 Linux 下明显比 Win7 下热。预计在 2.6.34 内核中会加入电源管理的支持。

用于 Nv 显卡的 Nouveau 在 2.6.33 中应 Linus 的强烈要求而迅速融入内核，目前已经__完全抛弃__了用户模式设置的支持。也算是后发优势，因为没有以往接口的拖累，代码修改时就不需要太多的顾忌。
